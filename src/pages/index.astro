---
import '../styles/global.css';
import Button from '@/components/Button.astro';
import MainLayout from '@/layouts/main.astro';
import TrailerGallery from '@/components/TrailerGallery.astro';
import NowPlaying from '@/components/NowPlaying.astro';

import { normalizeDate, parseDate } from '@/lib/utils'; // Import your date utility functions
import type { Movie } from '@/lib/types'

const today = normalizeDate(new Date()); // Normaliza la fecha actual

const formattedDate = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;

const response = await fetch("https://lagos.cinebox.mx/mobile/consultas/peliculas/PeliculasConFuncionesYHorarios.php", {
  method: "POST",
  headers: {
    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:138.0) Gecko/20100101 Firefox/138.0",
    "Accept": "application/json, text/javascript, */*; q=0.01",
    "Accept-Language": "en-US,en;q=0.5",
    "Accept-Encoding": "gzip, deflate, br, zstd",
    "Content-Type": "multipart/form-data; boundary=----geckoformboundaryb87b97c03da19448cbde738de806d6fb",
    "Origin": "https://www.cinemashenry.com.mx",
    "Sec-GPC": "1",
    "Connection": "keep-alive",
    "Referer": "https://www.cinemashenry.com.mx/",
    "Sec-Fetch-Dest": "empty",
    "Sec-Fetch-Mode": "cors",
    "Sec-Fetch-Site": "cross-site",
    "TE": "trailers",
  },
  body: `------geckoformboundaryb87b97c03da19448cbde738de806d6fb\r\nContent-Disposition: form-data; name="fecha"\r\n\r\n${formattedDate}\r\n------geckoformboundaryb87b97c03da19448cbde738de806d6fb--\r\n`,
});
const htmlText = await response.text(); // Get the response as text

// Attempt to parse the HTML response as JSON if it contains JSON-like data
let data;
try {
  data = JSON.parse(htmlText);
} catch (error) {
  console.error("Failed to parse response as JSON:", error);
  data = null; // Handle the case where the response is not JSON
}

const movies: Movie[] = data?.datos?.map((movie: any) => {
  const images = JSON.parse(movie.peliculas_imagenes); // Parse the JSON string

  return {
      title: movie.peliculas_nombre.toLowerCase(),
      duration: movie.peliculas_duracion,
      trailer: movie.peliculas_trailer,
      img_primary: images[0].url, // First image URL
      img_secondary: images[1]?.url, // Second image URL if available
      releaseDate: movie.fecha_estreno, // Parse release date
    };
  }) || [];

const nowPlaying: Movie[] = movies.filter((movie: Movie) => {
  const movieDate = parseDate(movie.releaseDate); // Parse the release date
  return normalizeDate(movieDate) <= today; // Movies released today or earlier
});

const upNext: Movie[] = movies.filter((movie: Movie) => {
  const movieDate = parseDate(movie.releaseDate); // Parse the release date
  return normalizeDate(movieDate) > today; // Movies releasing in the future
});
---

<MainLayout content={{ title: 'Henry Cinemas' }}>
  <div class="w-10/12 mx-auto grid">
  <TrailerGallery videos={upNext} />
  <NowPlaying movies={nowPlaying} />
    <!-- <Button>Tailwind Button in Astro!</Button> -->
    <!-- <a href="/markdown-page" class="p-4 underline">Markdown is also supported...</a> -->
  </div>
</MainLayout>

<script>
	import confetti from 'canvas-confetti';
	const button = document.body.querySelector('button');

	if (button) {
		button.addEventListener('click', () => confetti());
	}
</script>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-element-bundle.min.js"></script>

