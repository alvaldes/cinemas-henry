---
import { Clock, Play, Timer, ChevronRight } from '@lucide/astro';

// Generate today's date in DD/MM/YYYY format
const today = new Date();
const formattedDate = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;

const response = await fetch("https://lagos.cinebox.mx/mobile/consultas/peliculas/PeliculasConFuncionesYHorarios.php", {
  method: "POST",
  headers: {
    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:138.0) Gecko/20100101 Firefox/138.0",
    "Accept": "application/json, text/javascript, */*; q=0.01",
    "Accept-Language": "en-US,en;q=0.5",
    "Accept-Encoding": "gzip, deflate, br, zstd",
    "Content-Type": "multipart/form-data; boundary=----geckoformboundaryb87b97c03da19448cbde738de806d6fb",
    "Origin": "https://www.cinemashenry.com.mx",
    "Sec-GPC": "1",
    "Connection": "keep-alive",
    "Referer": "https://www.cinemashenry.com.mx/",
    "Sec-Fetch-Dest": "empty",
    "Sec-Fetch-Mode": "cors",
    "Sec-Fetch-Site": "cross-site",
    "TE": "trailers",
  },
  body: `------geckoformboundaryb87b97c03da19448cbde738de806d6fb\r\nContent-Disposition: form-data; name="fecha"\r\n\r\n${formattedDate}\r\n------geckoformboundaryb87b97c03da19448cbde738de806d6fb--\r\n`,
});
const htmlText = await response.text(); // Get the response as text

// Attempt to parse the HTML response as JSON if it contains JSON-like data
let data;
try {
  data = JSON.parse(htmlText);
} catch (error) {
  console.error("Failed to parse response as JSON:", error);
  data = null; // Handle the case where the response is not JSON
}

type Movie = {
  title: string;
  duration: string;
  trailer: string;
  img_primary: string;
  img_secondary?: string;
};

const movies: Movie[] = data?.datos?.map((movie: any) => {
  const images = JSON.parse(movie.peliculas_imagenes); // Parse the JSON string

  return {
    title: movie.peliculas_nombre.toLowerCase(),
    duration: movie.peliculas_duracion,
    trailer: movie.peliculas_trailer,
    img_primary: images[0].url, // First image URL
    img_secondary: images[1]?.url, // Second image URL if available
  };
}) || [];

---
<section class="py-6 text-white w-4/5 max-w-7xl mx-auto">
  <div class="mb-4">
    <h2 class="text-lg font-semibold flex items-center cursor-pointer">
      <span class="text-yellow-400 mr-1 text-xl">|</span> En Cines
      <ChevronRight class="h-5 w-5" />
    </h2>
  </div>

  <swiper-container 
    class="mySwiper"
    navigation="true"
    space-between="15"
    slides-per-view="auto"
  >
    {movies.map((movie) => (
      <swiper-slide class="!w-auto">
        <article class="bg-neutral-900 rounded-2xl shadow-md w-48 overflow-hidden">
          <div class="relative">
            <img src={movie.img_primary} alt={movie.title} class="object-cover w-full h-auto" />
          </div>
          <div class="p-2 h-42 flex flex-col justify-between">
            <div class="ml-2">
              <div class="flex items-center text-sm space-x-1 text-yellow-400 font-semibold">
                <Timer class="h-3.5 w-3.5" />
                <span>{movie.duration} min</span>
              </div>
              <h3 class="text-sm mt-1 font-medium capitalize">{movie.title}</h3>
            </div>
            <div class="flex flex-col gap-2">
              <button class="flex items-center justify-center gap-1 bg-neutral-800 hover:bg-red-200/10 text-sm font-semibold text-red-400 rounded-2xl py-2 cursor-pointer">
                <Clock class="h-5 w-5 mr-2" />
                Calendario
              </button>
            <a href={movie.trailer} target="_blank" class="flex items-center justify-center gap-1 hover:bg-neutral-800 text-xs text-white rounded-2xl py-2 cursor-pointer">
                <Play fill="white" class="h-3.5 w-3.5 mr-0" />
                Trailer
              </a>
            </div>
          </div>
        </article>
      </swiper-slide>
    ))}
  </swiper-container>

  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-element-bundle.min.js"></script>
</section>
